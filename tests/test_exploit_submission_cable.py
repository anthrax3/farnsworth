#!/usr/bin/env python2
# -*- coding: utf-8 -*-

from __future__ import absolute_import, unicode_literals

import time
import os

from nose.tools import *
from peewee import IntegrityError

from . import setup_each, teardown_each
from farnsworth.models import (ChallengeSet,
                               Exploit,
                               ExploitSubmissionCable,
                               RexJob,
                               Team)

class TestExploitSubmissionCable:
    def setup(self):
        setup_each()

    def teardown(self):
        teardown_each()

    def test_process_and_unprocessed(self):
        cs = ChallengeSet.create(name="foo")
        team = Team.create(name="opponent")
        exploit = Exploit.create(cs=cs, job=RexJob.create(), pov_type="type1",
                                 blob="abc", c_code="exploit it")
        cable = ExploitSubmissionCable.create(team=team, exploit=exploit, throws=10)

        assert_equals(len(ExploitSubmissionCable.unprocessed()), 1)

        cable.process()
        assert_equals(len(ExploitSubmissionCable.unprocessed()), 0)
