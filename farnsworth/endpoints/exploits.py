#!/usr/bin/env python
# -*- coding: utf-8 -*-

from .. import app, postgres
from flask import request
from utils import jsonify, filter_query, update_query

@app.route("/exploits")
@jsonify
def list_exploits():
    cursor = postgres.cursor()

    query = """SELECT id, cbn_id, job_id, pov_type,
                      created_at, updated_at,
                      payload
                      FROM exploits"""

    cursor.execute(query)

    return cursor.fetchall()

@app.route("/exploits/<int:exploit_id>")
@jsonify
def get_exploit(exploit_id):
    cursor = postgres.cursor()
    cursor.execute("""SELECT * FROM exploits WHERE id = %s""", [exploit_id])
    resource = cursor.fetchone()

    if resource:
        return resource
    else:
        return {'errors': ['not found']}, 404


@app.route("/exploits", methods=["POST"])
@jsonify
def create_exploit():
    cursor = postgres.cursor()

    exploit = request.get_json()
    print exploit
    cursor.execute("""INSERT INTO exploits (cbn_id, job_id, pov_type, payload)
                      VALUES (%(cbn_id)s, %(job_id)s, %(pov_type)s, %(payload)s)
                      RETURNING id, cbn_id, pov_type, payload, created_at, updated_at""",
                      exploit)

    if cursor.rowcount == 0:
        return {"errors": []}, 422
    else:
        return cursor.fetchone(), 201
